<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Travel Assistant</title>
    
    <!-- iOS 全螢幕設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4A5D45">

    <!-- 核心套件 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 字體引入 (Google Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind 設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', '"Helvetica Neue"', 'sans-serif'],
                        serif: ['"Noto Serif TC"', '"Hiragino Mincho ProN"', 'serif'],
                        mono: ['"SF Mono"', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                    },
                    colors: {
                        theme: {
                            main: '#566B54',   
                            dark: '#2F3A2C',
                            light: '#EBEHE8',  
                            paper: '#F7F6F2',  
                            surface: '#FFFFFF',
                            accent: '#C5A059', 
                            text: '#2C302E',   
                            subtext: '#828A85',
                            danger: '#C75C5C'
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(86, 107, 84, 0.1)',
                        'float': '0 10px 30px -5px rgba(0, 0, 0, 0.1)',
                        'card': '0 2px 8px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04)',
                        'input': '0 2px 5px rgba(0,0,0,0.03), inset 0 1px 2px rgba(255,255,255,0.8)'
                    },
                    spacing: {
                        'safe-top': 'env(safe-area-inset-top)',
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pop: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F7F6F2;
            color: #2C302E;
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        * { -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }
        input, textarea { user-select: text; -webkit-user-select: text; }
        
        /* 強制 Select 文字置中 (包含 iOS Safari) */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
            text-align: center;
            text-align-last: center; /* 關鍵屬性：修正 iOS 靠左問題 */
            padding: 0;
        }
        
        #app-container { 
            max-width: 480px; 
            margin: 0 auto; 
            background-color: #F7F6F2; 
            height: 100vh; 
            height: 100dvh; 
            overflow: hidden; 
            position: relative; 
            box-shadow: 0 0 40px rgba(0,0,0,0.08); 
            display: flex; 
            flex-direction: column; 
        }
        
        .bg-washi { 
            background-color: #F7F6F2;
            background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        }
        
        .dragging { opacity: 0.9; transform: scale(1.02) rotate(1deg); box-shadow: 0 15px 30px rgba(0,0,0,0.15); z-index: 50; }
        .card-expanded { background-color: #FFFFFF; box-shadow: 0 8px 30px rgba(0,0,0,0.08); transform: translateY(-2px); }
        
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .glass-dark { background: rgba(47, 58, 44, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        
        .text-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app">
    <div id="app-container" class="bg-washi">
        
        <!-- Toast 通知 -->
        <transition enter-active-class="animate-pop" leave-active-class="transition-opacity duration-300 opacity-0">
            <div v-if="toast.show" class="fixed top-safe-top mt-4 left-0 right-0 z-[100] flex justify-center pointer-events-none px-6">
                <div :class="['px-5 py-2.5 rounded-full shadow-lg text-sm font-medium flex items-center backdrop-blur-md tracking-wider border border-white/20', toast.type === 'success' ? 'bg-theme-dark/90 text-white' : 'bg-theme-danger/90 text-white']">
                    <i :class="['mr-2 text-xs', toast.type === 'success' ? 'fas fa-check' : 'fas fa-exclamation-circle']"></i>
                    {{ toast.message }}
                </div>
            </div>
        </transition>

        <!-- 同步狀態指示器 (新增) -->
        <div class="fixed top-safe-top mt-1 right-2 z-20 flex items-center space-x-1" @click="copyShareLink">
             <div :class="['w-2 h-2 rounded-full transition-colors duration-500', isSyncing ? 'bg-yellow-400 animate-pulse' : 'bg-green-400']"></div>
             <span class="text-[9px] text-theme-subtext font-mono opacity-50">{{ isSyncing ? 'SYNC...' : 'ONLINE' }}</span>
        </div>

        <!-- 確認對話框 (Modal) -->
        <transition enter-active-class="transition duration-200 ease-out" enter-from-class="opacity-0" enter-to-class="opacity-100" leave-active-class="transition duration-150 ease-in" leave-from-class="opacity-100" leave-to-class="opacity-0">
            <div v-if="confirmModal.show" class="fixed inset-0 z-[100] bg-theme-dark/30 backdrop-blur-[2px] flex items-center justify-center p-6">
                <div class="bg-white rounded-2xl w-full max-w-[280px] p-6 shadow-float animate-pop border border-white/60">
                    <h3 class="text-lg font-serif font-bold text-theme-text mb-2 text-center tracking-widest">{{ confirmModal.title }}</h3>
                    <p class="text-sm text-theme-subtext mb-6 text-center leading-relaxed font-light">{{ confirmModal.message }}</p>
                    <div class="flex gap-3">
                        <button @click="confirmModal.show = false" class="flex-1 py-2.5 bg-gray-100 text-gray-500 rounded-lg text-xs font-bold tracking-widest hover:bg-gray-200 transition">取消</button>
                        <button @click="executeConfirm" class="flex-1 py-2.5 bg-theme-main text-white rounded-lg shadow-lg shadow-theme-main/30 text-xs font-bold tracking-widest hover:bg-theme-dark transition">確定</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 歡迎嚮導 (Wizard) -->
        <div v-if="showWizard" class="fixed inset-0 z-50 bg-theme-main flex flex-col items-center justify-center p-10 text-white animate-fade-in">
            <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/washi.png')] mix-blend-overlay"></div>
            <div class="relative w-full max-w-sm z-10 flex flex-col items-center">
                <div class="mb-12 text-center">
                    <div class="w-24 h-24 border border-white/20 rounded-full flex items-center justify-center mx-auto mb-6 backdrop-blur-sm bg-white/5"><i class="fas fa-torii-gate text-4xl opacity-90"></i></div>
                    <h1 class="text-4xl font-serif font-bold mb-3 tracking-[0.3em] ml-2">旅程</h1>
                    <p class="text-[10px] opacity-60 font-light tracking-[0.4em] uppercase">The Journey Begins</p>
                </div>
                <div class="space-y-8 w-full">
                    <div class="group">
                        <label class="block text-[10px] font-bold mb-2 uppercase opacity-50 tracking-widest text-center group-focus-within:opacity-100 transition-opacity">目的地</label>
                        <input type="text" v-model="tempDestination" placeholder="Kyoto" class="w-full bg-transparent border-b border-white/30 p-2 text-white text-center font-serif text-2xl outline-none placeholder-white/10 focus:border-white transition" @input="detectCurrency">
                        <p v-if="detectedInfo" class="text-[10px] text-theme-accent mt-2 text-center tracking-wider opacity-80 animate-fade-in">{{ detectedInfo }}</p>
                    </div>
                    <div class="group">
                        <label class="block text-[10px] font-bold mb-2 uppercase opacity-50 tracking-widest text-center group-focus-within:opacity-100 transition-opacity">出發日</label>
                        <input type="date" v-model="tempStartDate" class="w-full bg-transparent border-b border-white/30 p-2 text-white text-center font-serif text-lg outline-none focus:border-white transition opacity-90">
                    </div>
                    <button @click="finishWizard" :disabled="!tempDestination || !tempStartDate" class="w-full py-4 mt-10 bg-[#F7F6F2] text-theme-main rounded-xl shadow-lg shadow-black/10 disabled:opacity-50 hover:scale-[1.02] active:scale-95 transition-all text-sm tracking-[0.2em] font-bold">開始旅程</button>
                </div>
            </div>
        </div>

        <template v-else>
            <!-- Header -->
            <header class="glass text-theme-text pt-safe-top pb-2 px-6 shadow-sm z-30 flex justify-between items-center sticky top-0 shrink-0 h-[calc(60px+env(safe-area-inset-top))] transition-all">
                <div class="flex-1 min-w-0 mr-4 cursor-pointer" @click="copyShareLink">
                    <div class="flex items-center gap-2">
                         <h1 class="text-xl font-serif font-bold tracking-widest truncate text-theme-dark">{{ destination }}</h1>
                         <i class="fas fa-share-alt text-[10px] text-theme-main/50"></i>
                    </div>
                    <p class="text-[9px] text-theme-subtext uppercase tracking-[0.25em] font-medium mt-0.5">Travel Guide #{{ currentTripId.slice(0,4) }}</p>
                </div>
                <button @click="showSettingsModal = true" class="w-9 h-9 rounded-full bg-theme-light/50 hover:bg-theme-light flex items-center justify-center transition active:scale-90 text-theme-subtext"><i class="fas fa-cog text-sm"></i></button>
            </header>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto pb-32 no-scrollbar scroll-smooth relative bg-washi" ref="mainContent" 
                  @touchstart="onMainTouchStart" @touchmove="onMainTouchMove" @touchend="onMainTouchEnd">
                
                <!-- 1. Schedule Tab -->
                <div v-if="currentTab === 'schedule'" class="p-4 animate-fade-in min-h-full">
                    <!-- 日期列 (Sticky) -->
                    <div class="sticky top-0 z-20 py-3 -mx-4 px-4 mb-2 bg-gradient-to-b from-[#F7F6F2] via-[#F7F6F2] to-transparent">
                        <div class="flex justify-between items-center mb-1">
                            <div ref="dateContainer" class="flex-1 overflow-x-auto flex space-x-3 no-scrollbar cursor-grab active:cursor-grabbing py-2 px-1 snap-x" @mousedown="onDateDragStart" @mousemove="onDateDragMove" @mouseup="onDateDragEnd" @mouseleave="onDateDragEnd" @touchstart.stop>
                                <button v-for="(day, index) in days" :key="index" @click="currentDayIndex = index" 
                                        :class="['snap-center flex-shrink-0 px-4 py-2.5 rounded-xl border transition-all duration-300 flex flex-col items-center min-w-[70px]', 
                                                 currentDayIndex === index ? 'bg-theme-main text-white border-theme-main shadow-lg shadow-theme-main/25 scale-105' : 'bg-white text-theme-subtext border-transparent shadow-sm hover:bg-gray-50']">
                                    <span class="text-[10px] uppercase tracking-widest font-bold opacity-80 mb-0.5">Day {{ index + 1 }}</span>
                                    <span class="text-sm font-serif font-bold">{{ getDayDate(index) }}</span>
                                </button>
                                <div class="w-2 flex-shrink-0"></div>
                            </div>
                            <div class="flex space-x-2 pl-3 ml-2 border-l border-gray-200">
                                <button v-if="days.length > 1" @click.stop="confirmDeleteDay" class="w-8 h-8 text-theme-danger bg-white border border-red-100 rounded-full flex items-center justify-center shadow-sm active:scale-90 transition"><i class="fas fa-minus text-[10px]"></i></button>
                                <button @click.stop="addDay" class="w-8 h-8 text-theme-main bg-white border border-theme-main/20 rounded-full flex items-center justify-center shadow-sm active:scale-90 transition"><i class="fas fa-plus text-[10px]"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4 pb-20 px-1">
                        <div v-if="currentDayItems.length === 0" class="flex flex-col items-center justify-center py-24 text-theme-subtext opacity-40">
                            <i class="far fa-map text-4xl mb-4 text-theme-main/50"></i>
                            <p class="text-xs tracking-widest font-serif">本日尚無行程</p>
                        </div>
                        
                        <!-- 行程卡片列表 -->
                        <div v-for="(item, idx) in currentDayItems" :key="item.id" 
                             class="group relative bg-white rounded-xl shadow-card p-4 transition-all duration-300 border-l-[3px] border-theme-main"
                             :class="{'card-expanded': expandedItemId === item.id}"
                             @click="toggleExpand(item.id)"
                             draggable="true"
                             @dragstart="onDragStart($event, idx)" 
                             @dragover.prevent 
                             @drop="onDrop($event, idx)"
                             @touchstart="onTouchDragStart($event, idx)"
                             @touchmove="onTouchDragMove($event)"
                             @touchend="onTouchDragEnd">
                            
                            <div class="flex items-start">
                                <!-- 拖曳把手 -->
                                <div class="mr-3 text-gray-200 cursor-move touch-none self-center py-2 px-1 hover:text-theme-main transition" @click.stop @touchstart.stop><i class="fas fa-grip-vertical text-xs"></i></div>
                                
                                <div class="flex-1 min-w-0 select-none">
                                    <div class="flex items-baseline mb-1.5 flex-wrap gap-2">
                                        <span v-if="item.time" class="text-theme-main font-mono text-xs font-bold bg-theme-light/60 px-2 py-0.5 rounded tracking-wide">{{ item.time }}</span>
                                        <h3 class="text-theme-text font-serif font-bold tracking-wide text-base">{{ item.title }}</h3>
                                    </div>
                                    <!-- 顯示地址 -->
                                    <div v-if="item.location" class="inline-flex items-center text-theme-subtext text-xs mt-0.5 cursor-pointer hover:text-theme-main transition group-hover:text-theme-main/80" @click.stop="openMap(item.location)">
                                        <i class="fas fa-map-marker-alt mr-1.5 text-[10px]"></i>
                                        <span class="truncate border-b border-transparent hover:border-theme-main/50 transition-colors">{{ item.location }}</span>
                                    </div>
                                </div>

                                <!-- 操作按鈕 -->
                                <div class="flex flex-col gap-2 ml-3 opacity-80">
                                    <button @click.stop="editItem(item)" class="w-7 h-7 rounded-full bg-gray-50 text-gray-400 hover:text-theme-main hover:bg-theme-light flex items-center justify-center transition shadow-sm"><i class="fas fa-pen text-[10px]"></i></button>
                                    <button @click.stop="confirmDeleteItem(item.id)" class="w-7 h-7 rounded-full bg-gray-50 text-gray-400 hover:text-theme-danger hover:bg-red-50 flex items-center justify-center transition shadow-sm"><i class="fas fa-trash text-[10px]"></i></button>
                                </div>
                            </div>

                            <!-- 展開備註區 -->
                            <div v-if="expandedItemId === item.id && item.note" class="mt-4 pt-3 border-t border-dashed border-gray-100 text-sm animate-slide-up cursor-text" @click.stop>
                                <div class="text-[9px] text-theme-accent uppercase tracking-widest mb-1.5 font-bold flex items-center"><i class="fas fa-sticky-note mr-1.5"></i>NOTE</div>
                                <div class="whitespace-pre-wrap font-sans text-xs text-gray-600 leading-relaxed pl-1">{{ item.note }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Budget Tab -->
                <div v-if="currentTab === 'money'" class="p-4 animate-fade-in min-h-full">
                    <!-- 總覽卡片 -->
                    <div class="bg-gradient-to-br from-theme-main to-theme-dark rounded-2xl p-6 text-white shadow-soft mb-8 relative overflow-hidden isolate">
                        <div class="absolute -right-10 -top-10 w-48 h-48 bg-white/5 rounded-full blur-3xl pointer-events-none -z-10"></div>
                        <div class="absolute left-0 bottom-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 -z-10"></div>
                        
                        <div class="relative z-10 flex flex-col items-center">
                            <p class="text-[9px] text-white/70 uppercase tracking-[0.3em] mb-3 border border-white/20 px-3 py-1 rounded-full">Total Expenses</p>
                            <h2 class="text-4xl font-serif font-bold mb-2 tracking-wide text-white drop-shadow-sm">{{ currencySymbol }} {{ totalExpense.toLocaleString() }}</h2>
                            <p class="text-xs text-theme-accent font-mono tracking-widest opacity-90 mb-6">≈ NT$ {{ toTWD(totalExpense) }}</p>
                            
                            <div class="flex gap-4 w-full max-w-[280px] justify-center">
                                <div class="bg-black/20 backdrop-blur-sm rounded-xl p-2.5 flex flex-col items-center border border-white/10 flex-1">
                                    <span class="text-[9px] text-white/60 mb-1 uppercase tracking-wider">匯率</span>
                                    <input type="number" v-model="exchangeRate" step="0.001" class="w-full bg-transparent text-center font-bold text-white text-sm focus:outline-none placeholder-white/30">
                                </div>
                                <button class="bg-black/20 backdrop-blur-sm rounded-xl p-2.5 flex flex-col items-center border border-white/10 hover:bg-black/30 transition flex-1" @click="showTravelerModal = true">
                                    <span class="text-[9px] text-white/60 mb-1 uppercase tracking-wider">旅伴</span>
                                    <span class="text-sm font-bold"><i class="fas fa-user-group text-xs mr-1.5"></i>{{ travelers.length }}</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 統計資訊 -->
                    <div class="flex flex-col space-y-4 mb-8 px-1">
                        
                        <!-- 卡片 1: 共同花費 (顯示明細) -->
                        <div class="bg-white rounded-2xl shadow-card border-t-4 border-theme-main p-5 relative overflow-hidden hover:shadow-md transition-shadow">
                            <div class="absolute right-0 top-0 w-32 h-32 bg-theme-main/5 rounded-full -mr-10 -mt-10 pointer-events-none"></div>
                            
                            <div class="flex justify-between items-start mb-3 z-10 relative">
                                <div class="flex flex-col">
                                    <h3 class="text-sm font-bold text-theme-dark flex items-center">
                                        <span class="w-8 h-8 rounded-lg bg-theme-main/10 text-theme-main flex items-center justify-center mr-3 shadow-sm">
                                            <i class="fas fa-users text-sm"></i>
                                        </span>
                                        共同花費
                                    </h3>
                                    <p class="text-[10px] text-gray-400 mt-1 ml-11">包含所有標記為共同花費的支出</p>
                                </div>
                                <div class="text-right z-10">
                                    <p class="text-lg font-bold text-theme-main font-mono tracking-tight">{{ currencySymbol }}{{ Math.round(statistics.shared).toLocaleString() }}</p>
                                    <p class="text-[10px] text-gray-400 font-mono mt-0.5">≈ NT$ {{ toTWD(statistics.shared) }}</p>
                                </div>
                            </div>

                            <!-- 分擔明細區塊 -->
                            <div class="ml-11 mt-2 z-10 relative">
                                <div class="bg-gray-50 rounded-lg p-2 border border-gray-100/50">
                                    <div class="flex justify-between items-center mb-1 pb-1 border-b border-gray-200/50">
                                        <span class="text-[9px] font-bold text-gray-400">分擔對象</span>
                                        <span class="text-[9px] font-bold text-gray-400">應付金額</span>
                                    </div>
                                    <div class="space-y-1">
                                        <div v-for="t in travelers" :key="t" class="flex justify-between items-center text-[10px] text-theme-text">
                                            <span>{{ t }}</span>
                                            <span class="font-mono text-theme-main font-medium">{{ currencySymbol }}{{ Math.round(statistics.shared / (travelers.length || 1)).toLocaleString() }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 卡片 2+: 旅伴個人支出 (僅顯示私帳) -->
                        <template v-for="(t, i) in travelers" :key="t">
                            <div class="bg-white rounded-2xl shadow-card border-t-4 p-5 flex justify-between items-center relative overflow-hidden hover:shadow-md transition-shadow" :class="t === '我' ? 'border-theme-accent' : 'border-gray-300'">
                                 <div class="flex flex-col z-10 min-w-0 mr-4">
                                    <h3 class="text-sm font-bold text-theme-text flex items-center mb-1.5 truncate">
                                        <span class="w-8 h-8 rounded-lg flex items-center justify-center mr-3 shadow-sm shrink-0" :class="t === '我' ? 'bg-theme-accent/10 text-theme-accent' : 'bg-gray-100 text-gray-500'">
                                            <i class="fas fa-user-tag text-sm"></i>
                                        </span>
                                        <span class="truncate">{{ t }} 的個人支出</span>
                                    </h3>
                                    <p class="text-[10px] text-gray-400 leading-tight ml-11 pl-0.5 truncate">僅包含個人支出，不含共同花費</p>
                                </div>
                                <div class="text-right z-10 shrink-0">
                                    <p class="text-lg font-bold text-theme-text font-mono tracking-tight">{{ currencySymbol }}{{ Math.round(statistics.individual[t] || 0).toLocaleString() }}</p>
                                    <p class="text-[10px] text-gray-400 font-mono mt-0.5">NT$ {{ toTWD(statistics.individual[t] || 0) }}</p>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- 結算建議 -->
                    <div class="bg-white rounded-xl shadow-card border border-gray-50 overflow-hidden mb-8 mx-1">
                        <div class="bg-gray-50/80 px-5 py-3 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-serif font-bold text-theme-text text-sm tracking-widest flex items-center"><i class="fas fa-balance-scale-right mr-2.5 text-theme-subtext"></i>結算建議</h3>
                        </div>
                        <div v-if="debts.length > 0" class="divide-y divide-gray-50">
                            <div v-for="(debt, i) in debts" :key="i" class="p-4 flex items-center justify-between hover:bg-gray-50 transition">
                                <div class="flex items-center space-x-3 text-sm">
                                    <span class="font-bold text-theme-text bg-gray-100 px-2.5 py-1 rounded-md shadow-sm">{{ debt.from }}</span>
                                    <i class="fas fa-arrow-right text-gray-300 text-xs"></i>
                                    <span class="font-bold text-theme-text bg-gray-100 px-2.5 py-1 rounded-md shadow-sm">{{ debt.to }}</span>
                                </div>
                                <span class="font-bold text-theme-danger font-mono text-base tracking-tight">{{ currencySymbol }}{{ debt.amount.toLocaleString() }}</span>
                            </div>
                        </div>
                        <div v-else class="p-6 text-center text-sm text-theme-subtext font-light italic">目前帳務平衡，無需付款</div>
                    </div>

                    <!-- 消費紀錄 -->
                    <div class="flex justify-between items-center mb-4 px-2 mt-8">
                        <h3 class="font-bold text-theme-text text-base font-serif tracking-wider">最近消費</h3>
                        <div class="bg-gray-200/60 p-1 rounded-lg flex space-x-1">
                             <button @click="expenseFilter = 'all'" :class="['px-3 py-1.5 text-[10px] rounded-md transition duration-200', expenseFilter === 'all' ? 'bg-white shadow-sm text-theme-main font-bold' : 'text-gray-500 hover:text-gray-700']">全部</button>
                             <button @click="expenseFilter = 'shared'" :class="['px-3 py-1.5 text-[10px] rounded-md transition duration-200', expenseFilter === 'shared' ? 'bg-white shadow-sm text-theme-main font-bold' : 'text-gray-500 hover:text-gray-700']">共同</button>
                             <button @click="expenseFilter = 'individual'" :class="['px-3 py-1.5 text-[10px] rounded-md transition duration-200', expenseFilter === 'individual' ? 'bg-white shadow-sm text-theme-main font-bold' : 'text-gray-500 hover:text-gray-700']">個人</button>
                        </div>
                    </div>

                    <!-- 分組顯示的消費列表 -->
                    <div class="space-y-6 pb-24 px-1">
                        <div v-for="group in groupedExpenses" :key="group.date">
                            <!-- 日期標題 (Click to toggle) -->
                            <div @click="toggleDateGroup(group.date)" class="sticky top-0 z-10 bg-[#F7F6F2]/95 backdrop-blur-sm py-3 mb-2 px-3 border-l-4 border-theme-light flex justify-between items-center cursor-pointer group transition-all hover:bg-white/50 hover:shadow-sm">
                                <div class="flex items-center gap-2">
                                    <i :class="['fas fa-chevron-right text-gray-400 text-[10px] transition-transform duration-300', expandedDates.includes(group.date) ? 'rotate-90' : '']"></i>
                                    <h4 class="text-xs font-bold text-theme-text tracking-widest">{{ group.displayDate }}</h4>
                                </div>
                                <span class="text-[10px] text-gray-400 font-mono bg-gray-100/50 px-2 py-0.5 rounded-full">{{ currencySymbol }}{{ group.total.toLocaleString() }}</span>
                            </div>
                            
                            <!-- 該日期的消費項目 (v-show) -->
                            <div v-show="expandedDates.includes(group.date)" class="space-y-3 animate-fade-in">
                                <div v-for="exp in group.items" :key="exp.id" class="bg-white px-4 py-4 rounded-xl shadow-card border border-transparent hover:border-theme-light transition-all duration-300 flex justify-between items-center group relative overflow-hidden">
                                    <div :class="['absolute left-0 top-0 bottom-0 w-1.5', exp.type === 'shared' ? 'bg-theme-main' : 'bg-theme-accent']"></div>
                                    
                                    <div class="min-w-0 flex-1 pr-3 cursor-pointer pl-3" @click="editExpense(exp)">
                                        <div class="flex items-center mb-1.5">
                                            <p class="text-base font-bold text-theme-text truncate mr-2">{{ exp.title }}</p>
                                            <span v-if="exp.type === 'shared'" class="text-[9px] text-white bg-theme-main px-1.5 py-0.5 rounded-sm font-bold tracking-wider">公款</span>
                                            <span v-else class="text-[9px] text-white bg-theme-accent px-1.5 py-0.5 rounded-sm font-bold tracking-wider">私帳</span>
                                        </div>
                                        <div class="text-[10px] text-theme-subtext flex flex-wrap items-center gap-2 leading-none">
                                            <!-- 只顯示時間 -->
                                            <span class="font-mono bg-gray-100 px-1.5 py-1 rounded text-gray-500"><i class="far fa-clock mr-1"></i>{{ exp.time || '全天' }}</span>
                                            <span class="flex items-center"><i class="fas fa-hand-holding-usd mr-1 text-gray-300"></i><span class="text-theme-text/80 font-medium">{{ exp.payer }}</span></span>
                                            <span v-if="exp.type === 'individual'" class="flex items-center"><i class="fas fa-user-tag mr-1 text-gray-300"></i><span class="text-theme-text/80">{{ exp.beneficiaries.join(', ') }}</span></span>
                                        </div>
                                        <p v-if="exp.note" class="text-[11px] text-gray-500 mt-2 truncate flex items-center pl-1 border-l-2 border-gray-200"><i class="fas fa-pen text-[9px] mr-1.5 opacity-50"></i>{{ exp.note }}</p>
                                    </div>
                                    <div class="text-right flex-shrink-0 flex flex-col items-end pl-2">
                                        <p class="text-base font-bold text-theme-text font-mono tracking-tight">{{ currencySymbol }}{{ exp.amount.toLocaleString() }}</p>
                                        <p class="text-[10px] text-theme-subtext font-mono mb-2 opacity-80">≈ NT${{ toTWD(exp.amount) }}</p>
                                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity scale-90">
                                            <button @click.stop="editExpense(exp)" class="text-gray-400 hover:text-theme-main w-7 h-7 flex items-center justify-center rounded-full bg-gray-50 hover:bg-theme-light transition shadow-sm"><i class="fas fa-pen text-[10px]"></i></button>
                                            <button @click.stop="confirmDeleteExpense(exp.id)" class="text-gray-400 hover:text-theme-danger w-7 h-7 flex items-center justify-center rounded-full bg-gray-50 hover:bg-red-50 transition shadow-sm"><i class="fas fa-trash text-[10px]"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 若無消費紀錄 -->
                        <div v-if="filteredExpenses.length === 0" class="text-center py-10 text-gray-400 text-xs font-light">
                            尚無消費紀錄
                        </div>
                    </div>
                </div>

                <!-- 3. Memo Tab -->
                <div v-if="currentTab === 'memo'" class="p-6 animate-fade-in flex flex-col min-h-full">
                    <div class="mb-6 flex justify-between items-end border-b border-theme-dark/10 pb-4">
                        <div>
                            <h2 class="text-2xl font-serif font-bold text-theme-dark tracking-widest">記事本</h2>
                            <p class="text-[9px] text-theme-subtext uppercase tracking-[0.25em] mt-1 font-medium">Notes & Ideas</p>
                        </div>
                        <span class="text-[10px] text-theme-main bg-theme-light px-2 py-1 rounded-full font-mono">{{ notes.length }}</span>
                    </div>
                    
                    <div v-if="notes.length === 0" class="flex-1 flex flex-col items-center justify-center text-theme-subtext opacity-40 pb-32">
                        <i class="far fa-edit text-5xl mb-4 text-gray-300"></i>
                        <p class="text-xs tracking-widest font-serif">點擊右下角新增筆記</p>
                    </div>
                    
                    <div v-else class="space-y-4 pb-24 grid grid-cols-1 gap-4">
                        <div v-for="note in sortedNotes" :key="note.id" 
                             class="bg-white p-5 rounded-lg shadow-card border border-transparent hover:border-theme-accent/30 transition-all cursor-pointer relative group flex flex-col h-auto" 
                             @click="editNote(note)">
                             
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-base font-bold text-theme-text font-serif tracking-wide truncate flex-1 pr-4">{{ note.title || '無標題' }}</h3>
                                <button @click.stop="confirmDeleteNote(note.id)" class="text-gray-300 hover:text-theme-danger p-1 -mt-1 -mr-1 transition opacity-0 group-hover:opacity-100"><i class="fas fa-times"></i></button>
                            </div>
                            
                            <p class="text-xs text-theme-subtext line-clamp-4 leading-relaxed whitespace-pre-wrap font-light mb-4">{{ note.content }}</p>
                            
                            <div class="mt-auto pt-3 border-t border-dashed border-gray-100 flex justify-between items-center text-[9px] text-gray-400 font-mono uppercase">
                                <span>{{ new Date(note.updatedAt).toLocaleDateString() }}</span>
                                <span class="group-hover:text-theme-accent transition-colors">EDIT</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- FAB -->
            <transition enter-active-class="animate-pop">
                <button v-if="currentTab === 'schedule'" @click="showItemModal = true; isEditing = false; resetForm()" class="absolute bottom-[calc(90px+env(safe-area-inset-bottom))] right-6 w-14 h-14 bg-theme-main text-white rounded-2xl shadow-float flex items-center justify-center text-xl hover:bg-theme-dark transition-transform hover:scale-105 active:scale-95 z-40 group"><i class="fas fa-plus transition-transform group-hover:rotate-90"></i></button>
            </transition>
            <transition enter-active-class="animate-pop">
                <button v-if="currentTab === 'money'" @click="showExpenseModal = true; isExpenseEditing = false; resetExpenseForm()" class="absolute bottom-[calc(90px+env(safe-area-inset-bottom))] right-6 w-14 h-14 bg-theme-accent text-white rounded-2xl shadow-float flex items-center justify-center text-xl hover:bg-[#b08d4b] transition-transform hover:scale-105 active:scale-95 z-40"><i class="fas fa-pen"></i></button>
            </transition>
            <transition enter-active-class="animate-pop">
                <button v-if="currentTab === 'memo'" @click="showNoteModal = true; isNoteEditing = false; resetNoteForm()" class="absolute bottom-[calc(90px+env(safe-area-inset-bottom))] right-6 w-14 h-14 bg-theme-text text-white rounded-2xl shadow-float flex items-center justify-center text-xl hover:bg-black transition-transform hover:scale-105 active:scale-95 z-40"><i class="fas fa-plus"></i></button>
            </transition>

            <!-- Footer Nav -->
            <nav class="glass-dark text-white/40 h-[calc(65px+env(safe-area-inset-bottom))] pb-safe-bottom w-full z-40 flex justify-around items-center shrink-0 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] absolute bottom-0">
                <button @click="currentTab = 'schedule'" :class="['flex flex-col items-center w-1/3 py-2 transition-all duration-300 relative group', currentTab === 'schedule' ? 'text-theme-accent' : 'hover:text-white/70']">
                    <div v-if="currentTab === 'schedule'" class="absolute top-0 w-8 h-0.5 bg-theme-accent shadow-[0_0_10px_#C5A059]"></div>
                    <i class="fas fa-map text-lg mb-1.5 transition-transform group-active:scale-90"></i>
                    <span class="text-[9px] font-bold tracking-[0.2em] uppercase scale-90">Schedule</span>
                </button>
                <button @click="currentTab = 'money'" :class="['flex flex-col items-center w-1/3 py-2 transition-all duration-300 relative group', currentTab === 'money' ? 'text-theme-accent' : 'hover:text-white/70']">
                    <div v-if="currentTab === 'money'" class="absolute top-0 w-8 h-0.5 bg-theme-accent shadow-[0_0_10px_#C5A059]"></div>
                    <i class="fas fa-wallet text-lg mb-1.5 transition-transform group-active:scale-90"></i>
                    <span class="text-[9px] font-bold tracking-[0.2em] uppercase scale-90">Budget</span>
                </button>
                <button @click="currentTab = 'memo'" :class="['flex flex-col items-center w-1/3 py-2 transition-all duration-300 relative group', currentTab === 'memo' ? 'text-theme-accent' : 'hover:text-white/70']">
                    <div v-if="currentTab === 'memo'" class="absolute top-0 w-8 h-0.5 bg-theme-accent shadow-[0_0_10px_#C5A059]"></div>
                    <i class="fas fa-book-open text-lg mb-1.5 transition-transform group-active:scale-90"></i>
                    <span class="text-[9px] font-bold tracking-[0.2em] uppercase scale-90">Memo</span>
                </button>
            </nav>
        </template>

        <!-- Modals -->
        
        <!-- Schedule Modal (Independent Blocks) -->
        <div v-if="showItemModal" class="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center p-0 sm:p-6 backdrop-blur-[2px]" @click.self="showItemModal = false">
            <div class="bg-[#F9F9F9] w-full sm:max-w-sm rounded-t-3xl sm:rounded-2xl p-4 sm:p-6 shadow-2xl animate-slide-up sm:animate-pop pb-safe-bottom max-h-[90vh] overflow-y-auto overflow-x-hidden">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6 sm:hidden"></div>
                <h3 class="text-lg font-serif font-bold mb-6 text-theme-text tracking-widest text-center">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                <div class="space-y-4">
                    <!-- 時間與名稱 (完全分離) -->
                    <div class="flex gap-4">
                        <div class="w-24 flex-none">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider pl-1 text-center">時間</label>
                            <div class="bg-white rounded-xl shadow-input p-1">
                                <input type="time" v-model="formItem.time" class="w-full bg-transparent border-none text-sm font-mono focus:ring-0 text-center h-10">
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider pl-1">地點名稱</label>
                            <div class="relative bg-white rounded-xl shadow-input">
                                <input type="text" v-model="formItem.title" placeholder="例如: 清水寺" class="w-full bg-transparent border-none p-3 text-sm font-bold focus:ring-0 h-12 pr-10">
                                <button @click="searchGoogleMaps(formItem.title)" class="absolute right-1.5 top-1.5 h-9 w-9 flex items-center justify-center text-theme-main/60 hover:text-theme-main hover:bg-gray-100 rounded-lg transition" title="在 Google 地圖搜尋">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider pl-1">地址</label>
                        <div class="relative bg-white rounded-xl shadow-input">
                            <i class="fas fa-map-marker-alt absolute left-3.5 top-3.5 text-gray-300 text-sm"></i>
                            <input type="text" v-model="formItem.location" placeholder="輸入地址或貼上 Google Maps 連結" class="w-full bg-transparent border-none p-3 pl-9 text-sm focus:ring-0 h-12">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider pl-1">備註</label>
                        <textarea v-model="formItem.note" placeholder="備註事項..." class="w-full bg-white border-none rounded-xl p-3 text-sm h-24 focus:ring-0 resize-none shadow-input leading-relaxed"></textarea>
                    </div>
                </div>
                <div class="flex mt-8 gap-3">
                    <button @click="showItemModal=false" class="flex-1 bg-gray-200 text-gray-600 py-3.5 rounded-xl text-xs font-bold tracking-widest hover:bg-gray-300 transition">取消</button>
                    <button @click="saveItem" class="flex-1 bg-theme-main text-white py-3.5 rounded-xl text-xs font-bold tracking-widest shadow-lg shadow-theme-main/30 hover:bg-theme-dark transition">儲存</button>
                </div>
            </div>
        </div>
        
        <!-- Expense Modal (Aligned with Item/Amount) -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center p-0 sm:p-6 backdrop-blur-[2px]" @click.self="showExpenseModal = false">
            <div class="bg-[#F9F9F9] w-full sm:max-w-sm rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up sm:animate-pop max-h-[90vh] overflow-y-auto pb-safe-bottom">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6 sm:hidden"></div>
                <h3 class="text-lg font-serif font-bold mb-6 text-theme-text tracking-widest text-center">{{ isExpenseEditing ? '編輯支出' : '記一筆' }}</h3>
                
                <div class="space-y-4">
                    <!-- Date & Time (Aligned to row below) -->
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider pl-1">日期</label>
                            <div class="bg-white rounded-xl shadow-input p-1">
                                <input type="date" v-model="formExpense.date" class="w-full bg-transparent border-none text-sm focus:ring-0 h-10 text-center">
                            </div>
                        </div>
                        <!-- Width set to match the Amount field below (w-32) -->
                        <div class="w-32 flex-none">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider pl-1">時間</label>
                            <div class="bg-white rounded-xl shadow-input p-0 h-12 flex items-center justify-center overflow-hidden">
                                <select v-model="tempHourExp" @change="updateTime('expense')" class="h-full w-1/2 text-center text-sm font-mono font-bold bg-transparent outline-none cursor-pointer">
                                    <option v-for="h in 24" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option>
                                </select>
                                <span class="text-gray-300 font-bold pb-0.5">:</span>
                                <select v-model="tempMinuteExp" @change="updateTime('expense')" class="h-full w-1/2 text-center text-sm font-mono font-bold bg-transparent outline-none cursor-pointer">
                                    <option v-for="m in 60" :value="(m-1).toString().padStart(2, '0')">{{ (m-1).toString().padStart(2, '0') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Item & Amount -->
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider pl-1">項目</label>
                            <div class="bg-white rounded-xl shadow-input">
                                <input type="text" v-model="formExpense.title" placeholder="例如: 晚餐" class="w-full bg-transparent border-none p-3 text-sm font-bold focus:ring-0 h-12">
                            </div>
                        </div>
                        <div class="w-32 flex-none">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider pl-1">金額</label>
                            <div class="relative bg-white rounded-xl shadow-input">
                                <span class="absolute left-3 top-3 text-gray-400 text-xs font-bold pointer-events-none z-10">{{ currencySymbol }}</span>
                                <input type="number" v-model="formExpense.amount" placeholder="0" class="w-full bg-transparent border-none p-3 pl-8 text-sm font-mono text-right font-bold focus:ring-0 h-12 text-theme-dark">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1.5 uppercase tracking-wider pl-1">備註</label>
                        <div class="bg-white rounded-xl shadow-input">
                            <input type="text" v-model="formExpense.note" placeholder="備註 (選填)" class="w-full bg-transparent border-none p-3 text-sm focus:ring-0 h-12">
                        </div>
                    </div>
                    
                    <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                        <label class="block text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-wider">誰付錢 (Payer)</label>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="t in travelers" @click="formExpense.payer=t" :class="['px-3 py-1.5 rounded-lg text-xs font-medium transition-all', formExpense.payer===t?'bg-theme-dark text-white shadow-md transform scale-105':'bg-gray-100 text-gray-500 hover:bg-gray-200']">{{t}}</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                        <label class="block text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-wider">分帳方式 (Split)</label>
                        <div class="flex gap-2 mb-3 bg-gray-100 p-1 rounded-lg">
                            <button @click="toggleSplitMode('shared')" :class="['flex-1 py-2 text-[10px] font-bold rounded-md tracking-wider transition-all', isSharedMode ? 'bg-white text-theme-main shadow-sm' : 'text-gray-400']">共同分擔</button>
                            <button @click="toggleSplitMode('individual')" :class="['flex-1 py-2 text-[10px] font-bold rounded-md tracking-wider transition-all', !isSharedMode ? 'bg-white text-theme-main shadow-sm' : 'text-gray-400']">指定對象</button>
                        </div>
                        <div v-if="!isSharedMode" class="flex flex-wrap gap-2 animate-fade-in">
                            <div v-for="t in travelers" :key="t" @click="toggleBeneficiary(t)" :class="['cursor-pointer px-3 py-1.5 rounded-lg text-xs border transition select-none', formExpense.beneficiaries.includes(t) ? 'bg-theme-accent text-white border-theme-accent shadow-sm' : 'bg-transparent text-gray-400 border-gray-200']">{{ t }}</div>
                        </div>
                        <div v-else class="text-center text-[10px] text-gray-300 py-1 font-light italic">所有人平均分攤</div>
                    </div>
                </div>
                <div class="flex mt-6 gap-3">
                    <button @click="showExpenseModal=false" class="flex-1 bg-gray-200 text-gray-600 py-3.5 rounded-xl text-xs font-bold tracking-widest hover:bg-gray-300 transition">取消</button>
                    <button @click="saveExpense" class="flex-1 bg-theme-accent text-white py-3.5 rounded-xl text-xs font-bold tracking-widest shadow-lg shadow-theme-accent/30 hover:bg-[#b08d4b] transition">儲存</button>
                </div>
            </div>
        </div>

        <!-- Note Modal -->
        <div v-if="showNoteModal" class="fixed inset-0 bg-black/60 z-[60] flex items-end sm:items-center justify-center p-0 sm:p-6 backdrop-blur-[2px]" @click.self="showNoteModal = false">
            <div class="bg-[#F9F9F9] w-full sm:max-w-sm rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up sm:animate-pop h-[70vh] flex flex-col pb-safe-bottom">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4 sm:hidden flex-shrink-0"></div>
                <h3 class="text-lg font-serif font-bold mb-4 text-theme-text tracking-widest text-center flex-shrink-0">{{ isNoteEditing ? '編輯筆記' : '新增筆記' }}</h3>
                <div class="space-y-4 flex-1 flex flex-col min-h-0">
                    <input type="text" v-model="formNote.title" placeholder="標題" class="w-full bg-transparent border-b border-gray-200 p-2 text-xl font-serif font-bold focus:border-theme-text outline-none placeholder-gray-300 transition flex-shrink-0">
                    <textarea v-model="formNote.content" placeholder="開始輸入內容..." class="w-full bg-white/50 rounded-xl p-4 text-sm leading-relaxed focus:bg-white focus:shadow-inner outline-none resize-none flex-1 transition"></textarea>
                </div>
                <div class="flex mt-4 gap-3 shrink-0">
                    <button @click="showNoteModal=false" class="flex-1 bg-gray-200 text-gray-600 py-3.5 rounded-xl text-xs font-bold tracking-widest hover:bg-gray-300 transition">取消</button>
                    <button @click="saveNote" class="flex-1 bg-theme-text text-white py-3.5 rounded-xl text-xs font-bold tracking-widest shadow-lg shadow-black/20 hover:bg-black transition">儲存</button>
                </div>
            </div>
        </div>
        
        <!-- Traveler Modal -->
        <div v-if="showTravelerModal" class="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6 backdrop-blur-[2px]" @click.self="showTravelerModal = false">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-pop border border-white/50">
                <h3 class="text-lg font-serif font-bold mb-6 text-center tracking-widest text-theme-dark">旅伴名單</h3>
                <div class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-1">
                    <div v-for="(t,i) in travelers" class="flex items-center gap-3 group">
                        <div class="w-8 h-8 rounded-full bg-theme-light flex items-center justify-center text-xs font-bold text-theme-main shadow-inner">{{ i + 1 }}</div>
                        <input v-model="travelers[i]" class="flex-1 bg-gray-50 rounded-lg px-3 py-2 text-sm focus:bg-white focus:ring-1 focus:ring-theme-main outline-none transition" placeholder="名字">
                        <button @click="confirmRemoveTraveler(i)" class="text-gray-300 hover:text-theme-danger w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <button @click="travelers.push('新旅伴')" class="w-full py-2.5 border border-dashed border-gray-300 text-gray-400 rounded-xl text-xs hover:border-theme-main hover:text-theme-main hover:bg-theme-light/30 transition mb-4 font-bold tracking-wider"><i class="fas fa-plus mr-1"></i> 新增一位</button>
                <button @click="showTravelerModal=false" class="w-full py-3.5 bg-theme-main text-white rounded-xl text-xs font-bold tracking-widest shadow-lg shadow-theme-main/30 hover:bg-theme-dark transition">完成</button>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div v-if="showSettingsModal" class="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6 backdrop-blur-[2px]" @click.self="showSettingsModal=false">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-float animate-pop">
                <h3 class="text-lg font-serif font-bold mb-6 text-center tracking-widest">設定</h3>
                <div class="space-y-5 mb-8">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">目的地</label>
                        <input v-model="destination" class="w-full border-b border-gray-200 py-2 text-base font-serif focus:border-theme-main outline-none bg-transparent" @input="detectCurrencyForSetting">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">貨幣符號</label>
                        <input v-model="currencySymbol" class="w-full border-b border-gray-200 py-2 text-base font-mono focus:border-theme-main outline-none bg-transparent">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">出發日期</label>
                        <input type="date" v-model="startDate" class="w-full border-b border-gray-200 py-2 text-base font-mono focus:border-theme-main outline-none bg-transparent">
                    </div>
                    <!-- 旅程 ID 顯示 -->
                    <div class="pt-4 border-t border-gray-100">
                        <label class="text-[10px] font-bold text-theme-main uppercase tracking-wider mb-1 block">旅程同步代碼</label>
                        <div class="flex items-center gap-2">
                             <input readonly :value="currentTripId" class="w-full bg-gray-50 text-gray-500 py-2 px-3 rounded-lg text-xs font-mono select-all">
                             <button @click="copyShareLink" class="bg-theme-main text-white p-2 rounded-lg text-xs"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button @click="exportData" class="py-3 border border-gray-200 rounded-xl text-xs text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-file-export text-gray-400"></i>匯出備份
                    </button>
                    <button @click="triggerImport" class="py-3 border border-gray-200 rounded-xl text-xs text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-file-import text-gray-400"></i>匯入備份
                    </button>
                    <input type="file" ref="fileInput" @change="importData" class="hidden" accept=".json">
                </div>
                
                <div class="space-y-3">
                    <button @click="showSettingsModal = false" class="w-full py-3.5 bg-theme-main text-white rounded-xl text-xs font-bold tracking-widest shadow-lg shadow-theme-main/20">關閉</button>
                    <button @click="confirmResetData" class="w-full py-2 text-theme-danger text-[10px] hover:underline opacity-60 hover:opacity-100 transition">重置所有資料</button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // -------------------------------------------------------------
    // 【Firebase Config - 已自動填入】
    // -------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBxrqls2QxJO56vMgZRzJRF3WB-YPtJFlg",
      authDomain: "trip-52f6d.firebaseapp.com",
      projectId: "trip-52f6d",
      storageBucket: "trip-52f6d.firebasestorage.app",
      messagingSenderId: "893570994932",
      appId: "1:893570994932:web:44a06a6e3d1541077244a1",
      measurementId: "G-NFDNE56VN5"
    };

    // 初始化 Firebase
    let app, db;
    try {
        if (firebaseConfig.apiKey) {
             app = initializeApp(firebaseConfig);
             db = getFirestore(app);
             console.log("Firebase initialized");
        } else {
             console.warn("Firebase config is missing. App running in offline mode (demo only).");
        }
    } catch (e) {
        console.error("Firebase init error:", e);
    }

    // Vue Application
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // State
            const currentTab = ref('schedule');
            const currentDayIndex = ref(0);
            const days = ref([{ items: [] }, { items: [] }, { items: [] }]);
            const travelers = ref(['我', '旅伴']);
            const expenses = ref([]);
            const notes = ref([]); 
            const exchangeRate = ref(1);
            const startDate = ref('');
            const destination = ref('');
            const currencySymbol = ref('$');
            const showWizard = ref(false);
            const showItemModal = ref(false);
            const showExpenseModal = ref(false);
            const showTravelerModal = ref(false);
            const showSettingsModal = ref(false);
            const showNoteModal = ref(false); 
            const isEditing = ref(false);
            const isNoteEditing = ref(false);
            const isExpenseEditing = ref(false); 
            const expenseFilter = ref('all');
            const fileInput = ref(null);
            const tempDestination = ref('');
            const tempStartDate = ref('');
            const detectedInfo = ref('');
            const itemSwipes = ref({});
            const dragState = ref({ startX: 0, startY: 0, currentId: null, isMouseDown: false });
            const dragIndex = ref(null); 
            const dateContainer = ref(null);
            const dateDragState = ref({ isDown: false, startX: 0, scrollLeft: 0 });
            const expandedItemId = ref(null);
            const mainSwipeState = ref({ startX: 0, startY: 0, active: false });
            const toast = ref({ show: false, message: '', type: 'success' });
            const confirmModal = ref({ show: false, title: '', message: '', callback: null });
            
            // Sync State
            const isSyncing = ref(false);
            const currentTripId = ref('');
            
            // Time Picker state
            const tempHour = ref('00');
            const tempMinute = ref('00');
            const tempHourExp = ref('00');
            const tempMinuteExp = ref('00');
            
            // Forms
            const formItem = ref({ id: null, time: '', title: '', location: '', note: '' });
            const formExpense = ref({ id: null, title: '', amount: '', payer: '', beneficiaries: [], type: 'shared', date: '', time: '', note: '' });
            const formNote = ref({ id: null, title: '', content: '', updatedAt: '' });

            // Currency Map
            const currencyMap = { 'japan': { s: '¥', r: 0.21, n: '日幣' }, 'tokyo': { s: '¥', r: 0.21, n: '日幣' }, 'osaka': { s: '¥', r: 0.21, n: '日幣' }, 'kyoto': { s: '¥', r: 0.21, n: '日幣' }, 'uk': { s: '£', r: 41.5, n: '英鎊' }, 'london': { s: '£', r: 41.5, n: '英鎊' }, 'usa': { s: '$', r: 32.5, n: '美金' }, 'europe': { s: '€', r: 35.0, n: '歐元' }, 'korea': { s: '₩', r: 0.024, n: '韓元' }, 'thailand': { s: '฿', r: 0.9, n: '泰銖' }, 'taiwan': { s: 'NT$', r: 1, n: '台幣' }, '日本': { s: '¥', r: 0.21, n: '日幣' }, '東京': { s: '¥', r: 0.21, n: '日幣' }, '大阪': { s: '¥', r: 0.21, n: '日幣' }, '京都': { s: '¥', r: 0.21, n: '日幣' }, '英國': { s: '£', r: 41.5, n: '英鎊' }, '倫敦': { s: '£', r: 41.5, n: '英鎊' }, '美國': { s: '$', r: 32.5, n: '美金' }, '紐約': { s: '$', r: 32.5, n: '美金' }, '歐洲': { s: '€', r: 35.0, n: '歐元' }, '法國': { s: '€', r: 35.0, n: '歐元' }, '巴黎': { s: '€', r: 35.0, n: '歐元' }, '韓國': { s: '₩', r: 0.024, n: '韓元' }, '首爾': { s: '₩', r: 0.024, n: '韓元' }, '泰國': { s: '฿', r: 0.9, n: '泰銖' }, '曼谷': { s: '฿', r: 0.9, n: '泰銖' }, '台灣': { s: 'NT$', r: 1, n: '台幣' }, '台北': { s: 'NT$', r: 1, n: '台幣' }, '中國': { s: '¥', r: 4.5, n: '人民幣' }, '上海': { s: '¥', r: 4.5, n: '人民幣' }, '北京': { s: '¥', r: 4.5, n: '人民幣' } };

            // Computed
            const currentDayItems = computed(() => days.value[currentDayIndex.value]?.items || []);
            const isSharedMode = computed(() => formExpense.value.type === 'shared');
            const totalExpense = computed(() => expenses.value.reduce((sum, exp) => sum + Number(exp.amount), 0));
            const filteredExpenses = computed(() => {
                let list = expenseFilter.value === 'all' ? [...expenses.value] : expenses.value.filter(e => e.type === expenseFilter.value);
                return list.sort((a, b) => {
                    if (a.date !== b.date) return b.date.localeCompare(a.date);
                    return (b.time || '').localeCompare(a.time || '');
                });
            });
            const sortedNotes = computed(() => [...notes.value].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))); 
            
            const debts = computed(() => {
                let balances = {}; travelers.value.forEach(t => balances[t] = 0);
                expenses.value.forEach(exp => {
                    const amount = Number(exp.amount); const payer = exp.payer;
                    if (balances[payer] === undefined) balances[payer] = 0;
                    let beneficiaries = exp.type === 'shared' ? travelers.value : exp.beneficiaries;
                    if (!beneficiaries || beneficiaries.length === 0) beneficiaries = [payer];
                    const splitAmount = amount / beneficiaries.length;
                    balances[payer] += amount; 
                    beneficiaries.forEach(b => { if (balances[b] !== undefined) balances[b] -= splitAmount; });
                });
                let result = [], debtors = [], creditors = [];
                for (const [p, a] of Object.entries(balances)) { if (a < -1) debtors.push({ p, a }); if (a > 1) creditors.push({ p, a }); }
                debtors.sort((a, b) => a.a - b.a); creditors.sort((a, b) => b.a - a.a);
                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i], creditor = creditors[j];
                    let amount = Math.min(Math.abs(debtor.a), creditor.a);
                    result.push({ from: debtor.p, to: creditor.p, amount: Math.round(amount) });
                    debtor.a += amount; creditor.a -= amount;
                    if (Math.abs(debtor.a) < 1) i++; if (creditor.a < 1) j++;
                }
                return result;
            });
            const statistics = computed(() => {
                let stats = { shared: 0, individual: {} }; travelers.value.forEach(t => stats.individual[t] = 0);
                expenses.value.forEach(exp => {
                    const amount = Number(exp.amount);
                    if (exp.type === 'shared') stats.shared += amount;
                    else {
                        const benes = exp.beneficiaries;
                        if (benes && benes.length > 0) {
                            const split = amount / benes.length;
                            benes.forEach(b => { if (stats.individual[b] === undefined) stats.individual[b] = 0; stats.individual[b] += split; });
                        }
                    }
                });
                return stats;
            });

            const groupedExpenses = computed(() => {
                const groups = {};
                // Sort expenses by date desc, time desc
                const sorted = [...filteredExpenses.value].sort((a, b) => {
                      if (a.date !== b.date) return b.date.localeCompare(a.date);
                      return (b.time || '').localeCompare(a.time || '');
                });

                sorted.forEach(exp => {
                    const dateKey = exp.date || 'no-date';
                    if (!groups[dateKey]) {
                        groups[dateKey] = [];
                    }
                    groups[dateKey].push(exp);
                });
                
                // Sort dates descending
                const sortedKeys = Object.keys(groups).sort((a, b) => {
                    if (a === 'no-date') return 1;
                    if (b === 'no-date') return -1;
                    return b.localeCompare(a);
                });

                return sortedKeys.map(date => {
                    if (date === 'no-date') return { date, displayDate: '未設定日期', items: groups[date], total: groups[date].reduce((sum, item) => sum + item.amount, 0) };
                    const d = new Date(date);
                    const days = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                    return {
                        date,
                        displayDate: `${d.getMonth() + 1}月${d.getDate()}日 ${days[d.getDay()]}`,
                        items: groups[date],
                        total: groups[date].reduce((sum, item) => sum + item.amount, 0)
                    };
                });
            });

            // Utils
            const showToast = (msg, type = 'success') => { toast.value = { show: true, message: msg, type }; setTimeout(() => toast.value.show = false, 3000); };
            const triggerConfirm = (title, message, callback) => { confirmModal.value = { show: true, title, message, callback }; };
            const executeConfirm = () => { if (confirmModal.value.callback) confirmModal.value.callback(); confirmModal.value.show = false; };
            const toggleExpand = (id) => { if (itemSwipes.value[id] && itemSwipes.value[id] !== 0) { resetSwipe(id); return; } if (expandedItemId.value === id) expandedItemId.value = null; else expandedItemId.value = id; };
            const confirmDeleteDay = () => { if (days.value.length <= 1) return showToast('最少保留一天', 'error'); triggerConfirm('刪除天數', `確定刪除 Day ${currentDayIndex.value + 1}？`, () => { days.value.splice(currentDayIndex.value, 1); if (currentDayIndex.value >= days.value.length) currentDayIndex.value = Math.max(0, days.value.length - 1); showToast('已刪除'); }); };
            const confirmDeleteItem = (id) => { triggerConfirm('刪除行程', '確定要刪除？', () => { days.value[currentDayIndex.value].items = days.value[currentDayIndex.value].items.filter(i => i.id !== id); delete itemSwipes.value[id]; showToast('已刪除'); }); };
            const confirmDeleteExpense = (id) => { triggerConfirm('刪除記帳', '確定要刪除？', () => { expenses.value = expenses.value.filter(e => e.id !== id); showToast('已刪除'); }); };
            const confirmRemoveTraveler = (idx) => { triggerConfirm('移除旅伴', '確定嗎？', () => { travelers.value.splice(idx, 1); showToast('已移除'); }); };
            const confirmDeleteNote = (id) => { triggerConfirm('刪除筆記', '確定要刪除嗎？', () => { notes.value = notes.value.filter(n => n.id !== id); showToast('已刪除'); }); };
            
            const confirmResetData = () => { 
                triggerConfirm('重置資料', '資料將清空，確定嗎？', async () => { 
                    if (db && currentTripId.value) {
                         // Reset Remote Data
                         const defaultData = {
                             days: [{ items: [] }, { items: [] }, { items: [] }],
                             expenses: [],
                             travelers: ['我', '旅伴'],
                             notes: [],
                             startDate: '',
                             destination: '',
                             exchangeRate: 1,
                             currencySymbol: '$'
                         };
                         try {
                            await setDoc(doc(db, "trips", currentTripId.value), defaultData);
                            showToast('已重置');
                            location.reload();
                         } catch (e) {
                             showToast('重置失敗', 'error');
                         }
                    } else {
                        localStorage.removeItem('generic_trip_data'); 
                        location.reload(); 
                    }
                }); 
            };
            
            const addDay = () => { days.value.push({ items: [] }); currentDayIndex.value = days.value.length - 1; };
            const saveItem = () => { if (!formItem.value.title) return showToast('請輸入名稱', 'error'); const items = days.value[currentDayIndex.value].items; if (isEditing.value) { const idx = items.findIndex(i => i.id === formItem.value.id); if (idx !== -1) items[idx] = { ...formItem.value }; } else { items.push({ ...formItem.value, id: Date.now() }); } showItemModal.value = false; showToast('已儲存'); };
            
            const resetForm = () => { 
                formItem.value = { id: null, time: '', title: '', location: '', note: '' }; 
                tempHour.value = '09'; tempMinute.value = '00';
            };
            const editItem = (item) => { 
                formItem.value = { ...item }; 
                if(item.time) { const [h, m] = item.time.split(':'); tempHour.value = h; tempMinute.value = m; }
                isEditing.value = true; showItemModal.value = true; 
            };
            
            const resetExpenseForm = () => { 
                const now = new Date(); 
                formExpense.value = { id: null, title: '', amount: '', payer: travelers.value[0] || '', beneficiaries: [], type: 'shared', date: now.toLocaleDateString('en-CA'), time: now.toTimeString().slice(0, 5), note: '' }; 
                const [h, m] = now.toTimeString().slice(0, 5).split(':');
                tempHourExp.value = h; tempMinuteExp.value = m;
            };
            const editExpense = (exp) => { 
                formExpense.value = { ...exp }; 
                if(exp.time) { const [h, m] = exp.time.split(':'); tempHourExp.value = h; tempMinuteExp.value = m; }
                isExpenseEditing.value = true; showExpenseModal.value = true; 
            };
            
            const updateTime = (type) => {
                if (type === 'item') formItem.value.time = `${tempHour.value}:${tempMinute.value}`;
                else formExpense.value.time = `${tempHourExp.value}:${tempMinuteExp.value}`;
            };

            const saveExpense = () => { 
                if (!formExpense.value.title || !formExpense.value.amount) return showToast('資料不完整', 'error'); 
                const finalBeneficiaries = formExpense.value.type === 'shared' ? [...travelers.value] : [...formExpense.value.beneficiaries]; 
                if (formExpense.value.type === 'individual' && finalBeneficiaries.length === 0) return showToast('請選擇對象', 'error'); 
                
                // Ensure time is synced
                formExpense.value.time = `${tempHourExp.value}:${tempMinuteExp.value}`;

                if (isExpenseEditing.value) {
                    const idx = expenses.value.findIndex(e => e.id === formExpense.value.id);
                    if (idx !== -1) expenses.value[idx] = { ...formExpense.value, beneficiaries: finalBeneficiaries };
                } else {
                    expenses.value.unshift({ 
                        id: Date.now(), 
                        title: formExpense.value.title, 
                        amount: Number(formExpense.value.amount), 
                        payer: formExpense.value.payer, 
                        type: formExpense.value.type, 
                        beneficiaries: finalBeneficiaries, 
                        date: formExpense.value.date || new Date().toLocaleDateString('en-CA'), 
                        time: formExpense.value.time,
                        note: formExpense.value.note 
                    });
                }
                showExpenseModal.value = false; 
                showToast(isExpenseEditing.value ? '已更新' : '已記帳'); 
            };
            
            const toggleSplitMode = (mode) => { formExpense.value.type = mode; if (mode === 'shared') formExpense.value.beneficiaries = []; };
            const toggleBeneficiary = (name) => { const idx = formExpense.value.beneficiaries.indexOf(name); if (idx > -1) formExpense.value.beneficiaries.splice(idx, 1); else formExpense.value.beneficiaries.push(name); };
            
            // Note Actions
            const resetNoteForm = () => { formNote.value = { id: null, title: '', content: '', updatedAt: '' }; };
            const editNote = (note) => { formNote.value = { ...note }; isNoteEditing.value = true; showNoteModal.value = true; };
            const saveNote = () => { 
                if (!formNote.value.title && !formNote.value.content) return showToast('請輸入內容', 'error'); 
                const now = new Date().toISOString();
                if (isNoteEditing.value) {
                    const idx = notes.value.findIndex(n => n.id === formNote.value.id);
                    if (idx !== -1) notes.value[idx] = { ...formNote.value, updatedAt: now };
                } else {
                    notes.value.unshift({ ...formNote.value, id: Date.now(), updatedAt: now });
                }
                showNoteModal.value = false;
                showToast('筆記已儲存');
            };

            const toTWD = (val) => Math.round(val * exchangeRate.value).toLocaleString();
            const getDayDate = (index) => { if(!startDate.value) return ''; const date = new Date(startDate.value); date.setDate(date.getDate() + index); return `${date.getMonth() + 1}/${date.getDate()}`; };
            const formatExpDate = (d, t) => { if (!d) return ''; const date = new Date(d); return `${date.getMonth() + 1}/${date.getDate()} ${t || ''}`; };
            
            const onDragStart = (e, index) => { dragIndex.value = index; e.dataTransfer.effectAllowed = 'move'; };
            const onDrop = (e, index) => { if (dragIndex.value !== null && dragIndex.value !== index) { const items = days.value[currentDayIndex.value].items; const temp = items[dragIndex.value]; items.splice(dragIndex.value, 1); items.splice(index, 0, temp); dragIndex.value = null; } };
            const onTouchDragStart = (e, index) => { dragState.value.isMouseDown = true; dragState.value.currentId = index; dragIndex.value = index; };
            const onTouchDragMove = (e) => { if (!dragState.value.isMouseDown) return; e.preventDefault(); const touch = e.touches[0]; const target = document.elementFromPoint(touch.clientX, touch.clientY); const listItem = target?.closest('[draggable]'); if (listItem) { const parent = listItem.parentNode; const children = Array.from(parent.children); const targetIndex = children.indexOf(listItem); if (targetIndex !== -1 && targetIndex !== dragIndex.value) { const items = days.value[currentDayIndex.value].items; const temp = items[dragIndex.value]; items.splice(dragIndex.value, 1); items.splice(targetIndex, 0, temp); dragIndex.value = targetIndex; } } };
            const onTouchDragEnd = () => { dragState.value.isMouseDown = false; dragIndex.value = null; };
            const onSwipeStart = (e, id) => { if (e.touches) dragState.value = { startX: e.touches[0].clientX, startY: e.touches[0].clientY, currentId: id, isMouseDown: true }; else if (e.button === 0) dragState.value = { startX: e.clientX, startY: e.clientY, currentId: id, isMouseDown: true }; };
            const onSwipeMove = (e, id) => { if (!dragState.value.isMouseDown || dragState.value.currentId !== id) return; const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const dx = clientX - dragState.value.startX; const dy = clientY - dragState.value.startY; if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) { let newOffset = dx; if (itemSwipes.value[id] === -144) newOffset += -144; if (newOffset > 0) newOffset = 0; if (newOffset < -144) newOffset = -144; for (let key in itemSwipes.value) { if (key != id) itemSwipes.value[key] = 0; } itemSwipes.value[id] = newOffset; if (e.cancelable && e.type.startsWith('touch')) e.preventDefault(); } };
            const onSwipeEnd = (e, id) => { if (dragState.value.currentId !== id) return; const current = itemSwipes.value[id] || 0; if (current < -72) itemSwipes.value[id] = -144; else itemSwipes.value[id] = 0; dragState.value.isMouseDown = false; dragState.value.currentId = null; };
            const resetSwipe = (id) => { itemSwipes.value[id] = 0; };
            const tabs = ['schedule', 'money', 'memo'];
            const onMainTouchStart = (e) => { if (dragState.value.isMouseDown || dateDragState.value.isDown) return; mainSwipeState.value.startX = e.touches[0].clientX; mainSwipeState.value.startY = e.touches[0].clientY; mainSwipeState.value.active = true; };
            const onMainTouchMove = (e) => { if (!mainSwipeState.value.active) return; const dx = e.touches[0].clientX - mainSwipeState.value.startX; const dy = e.touches[0].clientY - mainSwipeState.value.startY; if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 20) { if (e.cancelable) e.preventDefault(); } };
            const onMainTouchEnd = (e) => { if (!mainSwipeState.value.active) return; mainSwipeState.value.active = false; const dx = e.changedTouches[0].clientX - mainSwipeState.value.startX; const dy = e.changedTouches[0].clientY - mainSwipeState.value.startY; if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 60) { const idx = tabs.indexOf(currentTab.value); if (dx < 0 && idx < tabs.length - 1) currentTab.value = tabs[idx + 1]; else if (dx > 0 && idx > 0) currentTab.value = tabs[idx - 1]; } };
            const onDateDragStart = (e) => { dateDragState.value.isDown = true; dateDragState.value.startX = e.pageX - dateContainer.value.offsetLeft; dateDragState.value.scrollLeft = dateContainer.value.scrollLeft; };
            const onDateDragMove = (e) => { if (!dateDragState.value.isDown) return; e.preventDefault(); const x = e.pageX - dateContainer.value.offsetLeft; const walk = (x - dateDragState.value.startX) * 2; dateContainer.value.scrollLeft = dateDragState.value.scrollLeft - walk; };
            const onDateDragEnd = () => { dateDragState.value.isDown = false; };
            
            const detectCurrency = () => { const query = tempDestination.value.toLowerCase().trim(); let found = false; for (const key in currencyMap) { if (query.includes(key)) { const info = currencyMap[key]; exchangeRate.value = info.r; currencySymbol.value = info.s; detectedInfo.value = `${info.n} (${info.s}) 匯率約 ${info.r}`; found = true; break; } } if (!found) { detectedInfo.value = ''; exchangeRate.value = 1; currencySymbol.value = '$'; } };
            const detectCurrencyForSetting = () => { const query = destination.value.toLowerCase().trim(); for (const key in currencyMap) { if (query.includes(key)) { const info = currencyMap[key]; exchangeRate.value = info.r; currencySymbol.value = info.s; break; } } };
            const finishWizard = () => { destination.value = tempDestination.value; startDate.value = tempStartDate.value; showWizard.value = false; if (!detectedInfo.value) detectCurrency(); };
            const exportData = () => { const data = { days: days.value, expenses: expenses.value, travelers: travelers.value, notes: notes.value, exchangeRate: exchangeRate.value, startDate: startDate.value, destination: destination.value, currencySymbol: currencySymbol.value }; const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `trip_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
            const triggerImport = () => fileInput.value.click();
            const importData = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); triggerConfirm('匯入資料', '目前的資料將被覆蓋，確定嗎？', () => { days.value = data.days || days.value; expenses.value = data.expenses || []; travelers.value = data.travelers || travelers.value; notes.value = data.notes || []; if (data.exchangeRate) exchangeRate.value = data.exchangeRate; if (data.startDate) startDate.value = data.startDate; if (data.destination) destination.value = data.destination; if (data.currencySymbol) currencySymbol.value = data.currencySymbol; showToast('匯入成功'); showSettingsModal.value = false; }); } catch (err) { showToast('檔案格式錯誤', 'error'); } }; reader.readAsText(file); event.target.value = ''; };
            
            // Search Google Maps Function
            const searchGoogleMaps = (query) => {
                if (!query) return showToast('請先輸入地點名稱', 'error');
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
            };

            // Define missing functions for map
            const getGoogleMapsLink = (loc) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;
            const openMap = (loc) => window.open(getGoogleMapsLink(loc), '_blank');

            // Toggle for Date Groups
            const expandedDates = ref([]);
            const toggleDateGroup = (date) => {
                const idx = expandedDates.value.indexOf(date);
                if (idx > -1) expandedDates.value.splice(idx, 1);
                else expandedDates.value.push(date);
            };

            // -------------------------------------------------------------
            // FIREBASE SYNC LOGIC
            // -------------------------------------------------------------
            
            // Helper: Generate a random ID
            const generateId = () => Math.random().toString(36).substr(2, 9);

            // Helper: Get URL Parameter
            const getUrlParam = (name) => {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            };

            const copyShareLink = () => {
                const url = new URL(window.location.href);
                url.searchParams.set('trip', currentTripId.value);
                navigator.clipboard.writeText(url.toString()).then(() => {
                    showToast('已複製分享連結');
                }).catch(() => {
                    prompt("請複製連結傳給朋友:", url.toString());
                });
            };

            // Debounce Function
            const debounce = (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            };
            
            const loadData = () => { 
                // Check if Firebase is configured
                if (!db) {
                     // Fallback to local storage logic (for demo without keys)
                     console.warn("Using LocalStorage fallback");
                     const saved = localStorage.getItem('generic_trip_data'); 
                     if (saved) { 
                        const data = JSON.parse(saved); 
                        applyData(data);
                     } else { showWizard.value = true; }
                     return;
                }

                // Get Trip ID from URL or create new
                const tripIdFromUrl = getUrlParam('trip');
                if (tripIdFromUrl) {
                    currentTripId.value = tripIdFromUrl;
                } else {
                    // Check local storage for last used trip ID or generate new
                    const savedTripId = localStorage.getItem('last_trip_id');
                    currentTripId.value = savedTripId || generateId();
                    
                    // Update URL without reload if it's new
                    const url = new URL(window.location.href);
                    url.searchParams.set('trip', currentTripId.value);
                    try {
                        window.history.pushState({}, '', url);
                    } catch (e) {
                        console.warn("URL update blocked (sandbox environment):", e);
                    }
                }
                
                localStorage.setItem('last_trip_id', currentTripId.value);

                // Setup Listener
                isSyncing.value = true;
                onSnapshot(doc(db, "trips", currentTripId.value), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        applyData(data);
                    } else {
                        // New Trip
                        showWizard.value = true;
                    }
                    // Small delay to show "Online"
                    setTimeout(() => isSyncing.value = false, 500);
                }, (error) => {
                    console.error("Sync Error:", error);
                    showToast("同步失敗: 請檢查設定", "error");
                });
            };

            const applyData = (data) => {
                if (!data) return;
                days.value = data.days || days.value; 
                expenses.value = data.expenses || []; 
                travelers.value = data.travelers || travelers.value; 
                notes.value = data.notes || []; 
                if(data.exchangeRate) exchangeRate.value = data.exchangeRate; 
                if(data.startDate) startDate.value = data.startDate; 
                if(data.destination) destination.value = data.destination; 
                if(data.currencySymbol) currencySymbol.value = data.currencySymbol;
                
                // Auto-correct currency if missing
                if (data.destination && exchangeRate.value === 1 && currencySymbol.value === '$') {
                    const query = data.destination.toLowerCase().trim();
                    for (const key in currencyMap) {
                        if (query.includes(key)) {
                            const info = currencyMap[key];
                            exchangeRate.value = info.r;
                            currencySymbol.value = info.s;
                            break;
                        }
                    }
                }
            };
            
            // Save Data to Firebase
            const saveDataToFirebase = debounce(async () => {
                if (!db || !currentTripId.value) {
                    // Fallback local save
                    localStorage.setItem('generic_trip_data', JSON.stringify({ days: days.value, expenses: expenses.value, travelers: travelers.value, notes: notes.value, exchangeRate: exchangeRate.value, startDate: startDate.value, destination: destination.value, currencySymbol: currencySymbol.value }));
                    return;
                }

                isSyncing.value = true;
                const dataToSave = { 
                    days: days.value, 
                    expenses: expenses.value, 
                    travelers: travelers.value, 
                    notes: notes.value, 
                    exchangeRate: exchangeRate.value, 
                    startDate: startDate.value, 
                    destination: destination.value, 
                    currencySymbol: currencySymbol.value 
                };
                
                try {
                    await setDoc(doc(db, "trips", currentTripId.value), dataToSave, { merge: true });
                } catch (e) {
                    console.error("Save error", e);
                }
                setTimeout(() => isSyncing.value = false, 500);
            }, 1000); // 1 second debounce

            // Initialize expanded state with first group
            watch(groupedExpenses, (newVal) => {
                 if (newVal.length > 0 && expandedDates.value.length === 0) {
                      expandedDates.value.push(newVal[0].date);
                 }
            }, { immediate: true });

            // Watch for changes to save
            watch([days, expenses, travelers, notes, exchangeRate, startDate, destination, currencySymbol], () => { 
                saveDataToFirebase();
            }, { deep: true });
            
            onMounted(() => { loadData(); });

            return {
                currentTab, currentDayIndex, days, travelers, expenses, notes, exchangeRate, startDate, destination, currencySymbol, currentDayItems, totalExpense, filteredExpenses, debts, statistics, sortedNotes,
                showItemModal, showExpenseModal, showTravelerModal, showSettingsModal, showWizard, showNoteModal, toast, confirmModal, tempDestination, tempStartDate, detectedInfo, formItem, formExpense, formNote, isEditing, isNoteEditing, isExpenseEditing, expenseFilter, isSharedMode,
                detectCurrency, detectCurrencyForSetting, finishWizard, addDay, confirmDeleteDay, resetForm, editItem, saveItem, confirmDeleteItem, removeTraveler: confirmRemoveTraveler, resetExpenseForm, toggleSplitMode, toggleBeneficiary, saveExpense, confirmDeleteExpense, editExpense,
                resetNoteForm, editNote, saveNote, confirmDeleteNote,
                getGoogleMapsLink, confirmResetData, toTWD, getDayDate, formatExpDate, exportData, importData, triggerImport, fileInput,
                itemSwipes, onSwipeStart, onSwipeMove, onSwipeEnd, resetSwipe, dateContainer, onDateDragStart, onDateDragMove, onDateDragEnd, executeConfirm,
                onDragStart, onDrop, dragIndex, onTouchDragStart, onTouchDragMove, onTouchDragEnd, openMap,
                toggleExpand, expandedItemId,
                onMainTouchStart, onMainTouchMove, onMainTouchEnd, searchGoogleMaps, groupedExpenses, expandedDates, toggleDateGroup,
                tempHour, tempMinute, tempHourExp, tempMinuteExp, updateTime,
                // Sync specific
                isSyncing, currentTripId, copyShareLink
            };
        }
    }).mount('#app');
</script>
</body>
</html>